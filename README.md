# Endogenous-stratification

When we analyse the results of an experiment, we are often interested in understanding what the treatments effects are on sub-groups. This type of sub-group analysis is usually estimated using in-sample information on the relationship between the outcome of interest and the covariates in the control group to predict outcome for all groups without treatment. However, this procedure generates substantial bias due to overfitting. This results in a negative bias in the control observations in the lower interval, creating a positive bias in the estimated treatment effect for the group and the reverse problem in the upper interval. 

In order to avoid overfitting, the following approaches can be used:

1.	Leave one out estimators (LOO):  does not allow the outcome of each observation to contribute to the estimation of its own predicted value.
2.	Repeated sample splitting (RSS): in each split, the untreated sample is split into two -- one is used for prediction and the other is used for estimation.

Abadie, Chingos & West (2018) illustrate the use of these approaches, referred to as “endogenous stratification” using data from the National JTPA Study, a large experimental evaluation of an employment and training program. With overfitting, treatment effects are larger and significant in the ‘low’ group while the effects are larger and significant in the ‘high’ group when estimated using either LOO or RSS (Table 1).

Table 1: Reproduced from Abadie, Chingos & West (2018)
![Stratification 1](https://github.com/csae-coders-corner/Endogenous-stratification/assets/148211163/76e032c5-cfa2-4552-b978-9b67c47ad664)

Endogenous stratification is particularly helpful when there is a clear outcome variable of interest and there are a set of covariates that can be used for heterogeneity analysis. 

A stata module “estrat” can be used to run the analysis in Abadie, Chingos & West (2018).The code implements the following steps: 
  **Step 1**: regress the outcome variable of interest on the selected covariates in the control group.
  **Step 2**: Generates predicted values for the entire dataset based on predicted values obtained from LOO and RSS estimators and covariates supplied by user for the control group.
  **Step 3**: Uses these predicted values to split sample into user specified number of groups (in ascending order) and then estimates treatment effects for each group.

View the code.
As an illustration:
estrat outcome treat selected_covariates, groups(`groups’)
1.	outcome: the outcome variable of interest
2.	treat: a dummy equal to 1 for the treatment group and 0 for the control group. 
3.	selected_covariates: covariates that are to be used to predict the outcome variable of interest. 
4.	groups: number of groups that you want to split the sample into for analysis. 

It provides the treatment effects for each group, using both LOO and RSS, and bootstrapped standard errors for each. It produces the following output when three groups are selected:  

![Stratification 2](https://github.com/csae-coders-corner/Endogenous-stratification/assets/148211163/ac4357b5-7004-4055-b81e-9ba273645ace)

Notes: 
1.	The default code only works for (one) treatment versus control.
2.	The option ‘savegroup’ will save the groups generated by LOO. 
3.	Abadie, Chingos & West, 2018 use three groups in their analysis. Gelman and Park (2008) provide some useful guidelines on the optimal number of groups. 
4.	The selection of baseline covariates to predict the outcomes of interest can be done using theory or prediction can be done using nonparametric/machine learning techniques.

## References:
Abadie, A., Chingos, M. M., andWest, M. R. (2018). Endogenous stratification in randomized experiments. Review of Economics and Statistics, 100(4):567-580.

Gelman, A. and Park, D. K. (2009). Splitting a predictor at the upper quarter or third and the lower quarter or third. The American Statistician, 63(1):1-8.
 


